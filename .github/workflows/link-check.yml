name: Update Readme and Link Check

on:
  schedule:
    - cron: '0 15 * * *' # æ—¥æœ¬æ™‚é–“ã®åˆå‰0æ™‚
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Advanced Link Check
        run: |
          LAST_UPDATE="2026-02-10"
          NEXT_UPDATE=$(date -d "$LAST_UPDATE + 60 days" +%Y-%m-%d)
          # LINK_URL="https://gemini.google.com/share/935ca94636c9"
          LINK_URL="https://gemini.google.com/share/bec95c772552"

          # ãƒšãƒ¼ã‚¸ã®ä¸­èº«ã‚’å–å¾—ã—ã¦ã€ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹: neonï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹æ¤œç´¢ã™ã‚‹ã‚
          # -L ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¿½ã„ã‹ã‘ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚ˆ
          PAGE_CONTENT=$(curl -sL "$LINK_URL")

          curl -sL "$LINK_URL" > temp.html
          echo "--- START OF HTML ---"
          cat temp.html
          echo "--- END OF HTML ---"

          # ã€Œneonã€ã¨ã„ã†å˜èªãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if echo "$PAGE_CONTENT" | grep -qi "neon"; then
            LINK_ALIVE=true
          else
            LINK_ALIVE=false
          fi

          CURRENT_DATE=$(date +%Y-%m-%d)
          DIFF=$(( ($(date -d "$CURRENT_DATE" +%s) - $(date -d "$LAST_UPDATE" +%s)) / 86400 ))

          if [ "$LINK_ALIVE" = false ]; then
            STATUS="ğŸ”´ **ã€ãƒªãƒ³ã‚¯åˆ‡ã‚Œæ¤œçŸ¥ã€‘** å…±æœ‰ãƒªãƒ³ã‚¯ãŒå¤±åŠ¹ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™(share link expired)  \næœ€çµ‚æ›´æ–°æ—¥(last update): $LAST_UPDATE"
          elif [ $DIFF -ge 60 ]; then
            STATUS="ğŸŸ¡ **ã¾ã‚‚ãªããƒªãƒ³ã‚¯åˆ‡ã‚Œ** å…±æœ‰ãƒªãƒ³ã‚¯(share link) æœ€çµ‚æ›´æ–°æ—¥(last update): $LAST_UPDATE ($DIFF æ—¥çµŒé)  \næ¬¡å›æ›´æ–°äºˆå®šæ—¥(next update): $NEXT_UPDATE"
          else
            STATUS="ğŸŸ¢ å…±æœ‰ãƒªãƒ³ã‚¯(share link) æœ€çµ‚æ›´æ–°æ—¥(last update): $LAST_UPDATE ($DIFF æ—¥çµŒé)  \næ¬¡å›æ›´æ–°äºˆå®šæ—¥(next update): $NEXT_UPDATE"
          fi

          # é­”æ³•ã®sedã‚³ãƒãƒ³ãƒ‰ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ç‰ˆï¼‰
          sed -i "/STATUS_START/,/STATUS_END/c\\\x3c\x21\x2d\x2d STATUS_START \x2d\x2d\x3e\n$STATUS  \n\x3c\x21\x2d\x2d STATUS_END \x2d\x2d\x3e" README.md

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Update link expiry status: $(date +%Y-%m-%d)" || exit 0
          git push